<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
  <title>Formulario de Registro</title>
      <!-- Enlazar paleta.css -->
  <link rel="stylesheet" type="text/css" href="../Informes/css/paleta.css">
  <link rel="stylesheet" type="text/css" href="../Informes/css/index.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="icon" href="../Informes/img/MI.ico" type="image/x-icon">
  <link rel="shortcut icon" href="../Informes/img/MI.ico" type="image/x-icon">
  <link rel="apple-touch-icon" sizes="180x180" href="../Informes/img/MI180.png">
  <link rel="icon" type="image/png" sizes="32x32" href="../Informes/img/MI32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../Informes/img/MI16.png">
  <link rel="manifest" href="manifest.json">
  

<!--LINK COMPONENT DE GOOGGLE MATERIAL WEB
 <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <script type="importmap">
    {
      "imports": {
        "@material/web/": "https://esm.run/@material/web/"
      }
    }
  </script>
  <script type="module">
    import '@material/web/all.js';
    import {styles as typescaleStyles} from '@material/web/typography/md-typescale-styles.js';

    document.adoptedStyleSheets.push(typescaleStyles.styleSheet);
  </script>
  -->
</head>

<body>  
  <menu id="menucontainer">
    <div id="menutop">
      <div id="menutopleft">©2024 EL JARDIN TOL-53140</div>
      <div id="menutopright">       
        <a href="../Informes/usr/logUsr.html">Login</a> | 
        <a href="../Informes/usr/regUsr.html">Registrese</a>       
      </div>
    </div>
    <!-- BARRA DE PROGRESO -->
    <div id="progress-container">
      <div id="progress-bar"></div>
    </div>
    <!-- END BARRA DE PROGRESO -->
   
  </menu>        
  
  <form id="myInform">  
    <div class="form-container"> 
      <!-- BARRA DE PROGRESO
      <div id="progress-container">
        <div id="progress-bar"></div>
      </div>
      END BARRA DE PROGRESO -->       
      <div id="headline">          
          <legend><h3>MI INFORME</h3></legend>

          <!-- ENCABEZADO RESULTADO CONSULTA DE GRUPO Y FACETA-->
           <!-- Mensaje de resultado -->
           <div id="status-message"></div>
          <div id="encabezado">
          <!-- Aquí podrías tener campos para mostrar el Grupo y la Faceta si lo deseas -->
              <div class="form-group-faceta">
                <label class="GF" id="grupo"><span> </span></label><label class="GF" id="faceta"><span > </span></label>
              </div>  
          </div>              
      </div>
        <!--CAMPO NOMBRE -->
      <div class="form-group">
          <label for="nombre">NOMBRE:</label>
            <select id="nombre" name="nombre" autocomplete="on" >
              <option value="" selected>Elige aquí tu nombre</option>
              <!-- Los nombres se llenarán aquí -->
            </select>            
      </div>

      <!--CAMPO CHECKBOX PARTICIPA-->
      <div class="form-group-inline hidden" id="participaContainer">
          <div id="fparticipa">
            <legend id="lparticipa">PARTICIPA:</legend>
            <input type="checkbox" name="participa" id="participa">
          </div>
      </div>

      <!--CAMPO ESTUDIOS-->
      <div class="form-group hidden" id="estudiosContainer" >
        <label for="estudios">ESTUDIOS:</label>
        <input type="text" id="estudios" name="estudios" placeholder="Ingresa tus estudios" maxlength="5">
      </div>

      <!--CAMPO HORAS-->
      <div class="form-group hidden" id="horasContainer">
          <label for="horas">HORAS:</label>
          <input type="text" id="horas" name="horas" placeholder="Ingresa las horas" maxlength="5">
      </div>

      <!--CAMPO CREDITO-->
      <div class="form-group hidden" id="creditoContainer">
          <label for="credito">CREDITO: 
            <span class="help-icon">?
              <!-- Tooltip que aparece al pasar el cursor sobre el icono -->
              <div class="tooltip">
                <ul>
                  <li>A-2: Construcción LDC</li>
                  <li>Ayuda a hermanos enfermos</li>
                  <li>Preparativos en Asambleas...</li>
                </ul> 
              </div>
            </span>
          </label>          
          <input type="text" id="credito" name="credito" placeholder="Horas: otro servicio">
          <!-- Icono de ayuda con tooltip dentro -->
            
      </div>

      <!--CAMPO COMENTARIOS-->
      <div class="form-group-textarea hidden" id="comentariosContainer">
          <label for="comentarios">COMENTARIOS:</label>
          <textarea id="comentarios" name="comentarios" rows="4" placeholder="Ingresa tus comentarios"></textarea>
      </div>

      <!--CAMPO BOTON SUBMIT ENVIAR-->
      <div class="form-group hidden" id="submitBtnContainer">
          <input type="submit" id="submitBtn" value="Enviar">
      </div>
      <!-- Modal de procesamiento -->
      <div id="processingModal" class="modal">
          <div class="modal-content">
            <h2>Procesando registro...</h2>
            <p>Por favor, espera mientras se envían los datos.</p>
          </div>
      </div>
    </div>  
  </form>
  
    <!-- AGRADECIMIENTOS POR EL REGISTRO-->
    <div id="thankYouMessage" style="display: none; text-align: center;">
      <!-- MUESTRA RESPUESTA DE HABER RECIBIDO EL REGISTRO DESDE APPSCRIPT -->
      <div id="response"></div>
      <img src="../Informes/img/MIGracias180.png" alt="Chulito Azul" style="width: 100px; height: 100px;">
      <h2>¡Recibimos tu informe!</h2>
      <div id="menumsg">
        <a href="#" id="Refresh" onclick="location.reload();">Nuevo Registro</a>
        <a href="#" id="Salir" onclick="window.close();">Salir</a>
      </div>
    </div>   
      

  <!-- FOOTER- PIE DE PAGINA-->
  <footer>
    <div>©2024 EL JARDIN TOL-53140</div>
    <div>       
      <a href="https://github.com/grupos53140/Informes/blob/main/CONDICIONES.md">Condiciones de uso</a> | 
      <a href="https://github.com/grupos53140/Informes/blob/main/PRIVACY.md">Política de privacidad</a>
    </div>
  </footer>

<!-- SECCION DE JAVASCRIPT-->
  <script>    
  // Variables para guardar los valores de grupo y faceta
  let grupo = {};
  let faceta = {};
    //Inicializar la barra de progreso
    finalizarBarraProgreso();
  

  // Obtener y llenar el dropdown con los nombres
  fetch('https://script.google.com/macros/s/AKfycbxqs2vqHWcHp3zpT_89IhSoi9OhQVS7Mpy3UGfeZP2C82YxDcL9zYm5q8oNVN_lYsCz/exec')
    .then(response => response.json())
    .then(data => {
      const dropdown = document.getElementById('nombre');
      data.forEach(nombre => {
        let option = document.createElement('option');
        option.text = nombre;
        option.value = nombre; // Aseguramos que el valor sea el nombre seleccionado
        dropdown.add(option);
      });

    });

    // Escuchar cuando el usuario selecciona un nombre
  document.getElementById('nombre').addEventListener('change', function() {
      const selectedName = this.value;

     // Iniciar la barra de progreso
     iniciarBarraProgreso();
    mostrarMensaje("Consultando...");

    // Realizar la consulta para obtener grupo y faceta basados en el nombre
    fetch(`https://script.google.com/macros/s/AKfycbxqs2vqHWcHp3zpT_89IhSoi9OhQVS7Mpy3UGfeZP2C82YxDcL9zYm5q8oNVN_lYsCz/exec?nombre=${selectedName}`)
    .then(response => response.json())
      .then(data => {
         // Finalizar la barra de progreso
         finalizarBarraProgreso();
            mostrarMensaje(" ", true);

        // Guardar los valores de grupo y faceta en las variables
        grupo = data.grupo;
        faceta = data.faceta; 
        

        // Para mostra en el formulario en etiquetas span:
        document.getElementById('grupo').textContent = data.grupo;
        document.getElementById('faceta').textContent = data.faceta;

        // Para comprobar que se guardaron correctamente:
        console.log("Grupo:", grupo);
        console.log("Faceta:", faceta);
        // Aquí no se actualiza el HTML, solo se guardan en variables

        finalizarBarraProgreso(); // Asegurarse que la barra llega al 100%
        checkFaceta(faceta);
      });
  });

    function checkFaceta(faceta) {
      if (faceta === 'PUB'|| faceta==='PUB_NB') {
        document.getElementById('participaContainer').classList.remove('hidden'); 
        document.getElementById('horasContainer').classList.add('hidden');
        document.getElementById('creditoContainer').classList.add('hidden');
        document.getElementById('estudiosContainer').classList.remove('hidden');
        document.getElementById('comentariosContainer').classList.remove('hidden');
        document.getElementById('submitBtnContainer').classList.remove('hidden');
        } else {
        document.getElementById('participaContainer').classList.remove('hidden'); 
        document.getElementById('horasContainer').classList.remove('hidden');  
        document.getElementById('creditoContainer').classList.remove('hidden');  
        document.getElementById('estudiosContainer').classList.remove('hidden');
        document.getElementById('comentariosContainer').classList.remove('hidden');
        document.getElementById('submitBtnContainer').classList.remove('hidden');

      }
    }


 //////////////////////////////////////////////////////////////////////////////////////////////////////
 //BARRA DE TIEMPO DE ESPERA PARA LA CONSULTA DE GRUPO Y FACETA
 /////////////////////////////////////////////////////////////////////////////////////////////////////
 
 // Función para iniciar la barra de progreso
function iniciarBarraProgreso() {
    const progressBar = document.getElementById('progress-bar');
    
    let progreso = 0;
    const intervalo = 100; // Intervalo en milisegundos (0.1 segundo)

    // Crear un intervalo para aumentar progresivamente el ancho de la barra
    const idIntervalo = setInterval(() => {
        progreso += 5; // Incremento del 5% cada 0.1 segundos
        progressBar.style.width = `${progreso}%`;

        // Si la barra alcanza el 95%, detener el avance (esperar respuesta real)
        if (progreso >= 100) {
            clearInterval(idIntervalo);
        }
    }, intervalo);
}

// Función para finalizar la barra de progreso al 100%
function finalizarBarraProgreso() {
    const progressBar = document.getElementById('progress-bar');
    progressBar.style.transition = 'width 0.5s ease';
    progressBar.style.width = '0%';
     
}

// Mensaje de estado
function mostrarMensaje(mensaje, isSuccess = false) {
    const statusMessage = document.getElementById('status-message');
    if (isSuccess) {
        statusMessage.innerHTML = `<span style="color: var(--color-blue-100);">${mensaje} <i class="fas fa-check-circle"></i></span>`;
    } else {
        statusMessage.textContent = mensaje;
    }
}


    
////////////////////////////////////////////////////////////////////////////////////////////////////////
//ENVIAR LOS DATOS DEL FORMULARIO
//////////////////////////////////////////////////////////////////////////////////////////////////////
document.getElementById('myInform').addEventListener('submit', function(event) {
  event.preventDefault(); // Evitar que el formulario se envíe de manera convencional

      // Mostrar el modal
      document.getElementById("processingModal").style.display = "block";

      // Deshabilitar el botón de enviar
      event.target.disabled = true;

  // Obtener los valores del formulario
  const nombre = document.getElementById('nombre').value;
  const participa = document.getElementById('participa').checked ? "TRUE" : "FALSE";
  const estudios = document.getElementById('estudios').value || 0;
  const horas = document.getElementById('horas').value || 0;
  const credito = document.getElementById('credito').value || 0;
  const comentarios = document.getElementById('comentarios').value || "--";

  // Enviar los datos al AppScript usando fetch
  fetch('https://script.google.com/macros/s/AKfycbxqs2vqHWcHp3zpT_89IhSoi9OhQVS7Mpy3UGfeZP2C82YxDcL9zYm5q8oNVN_lYsCz/exec', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
    },
    body: new URLSearchParams({
      'grupo': grupo,
      'faceta': faceta,
      'nombre': nombre,      
      'participa': participa,
      'estudios': estudios,
      'horas': horas,
      'credito': credito,
      'comentarios': comentarios,
    })
  })

  ///////////////////////////////////////////////////////////////////////////////////////////////////////////////
  // MODAL PROCESANDO REGISTRO
  ///////////////////////////////////////////////////////////////////////////////////////////////////////////////

 

  //MENSAJE RESPUESTA DEL APPSCRIPT DE GOOGLE SHEET
  .then(response => response.text())  // Leer la respuesta del AppScript
  .then(result => {
    console.log(result);  // Mostrar el resultado en la consola
    document.getElementById('response').textContent = result + "...Gracias!" ;  // Mostrar mensaje de éxito en la página
    document.getElementById('response').style.display='flex';
    document.getElementById('response').style.justifyContent='center';
    document.getElementById('response').style.flexDirection='row-reverse';
    document.getElementById('response').style.flexWrap='wrap';
    document.getElementById('response').style.alignItems='flex-start';
    document.getElementById('response').style.padding='20px';
   
    // Limpiar el formulario
    //document.getElementById('myInform').reset();  // Esto limpia todos los campos del formulario

    // Ocultar el modal una vez que se completa el procesamiento
    document.getElementById("processingModal").style.display = "none"; 

    // Volver a habilitar el botón de enviar
    event.target.disabled = false;

    // Ocultar el formulario y mostrar el mensaje de agradecimiento
    document.getElementById('myInform').style.display = 'none';
    document.getElementById('thankYouMessage').style.display ='flex';
    document.getElementById('thankYouMessage').style.flexDirection='column';
    document.getElementById('thankYouMessage').style.flexWrap='nowrap';
    document.getElementById('thankYouMessage').style.alignItems='center';
    document.getElementById('Refresh').style.display='block';

  })
  
  .catch(error => console.error('Error al enviar:', error));
  
});

  </script>

</body>
</html>
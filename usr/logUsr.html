<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Usuario</title>

    <!-- Librerías necesarias 
    <link rel="stylesheet" type="text/css" href="../css/index.css"> 
    -->
    <link rel="stylesheet" type="text/css" href="../css/paleta.css">
    
    
   
    <link rel="icon" href="../Informes/img/MI.ico" type="image/x-icon">
    <link rel="shortcut icon" href="../Informes/img/MI.ico" type="image/x-icon">
    <link rel="apple-touch-icon" sizes="180x180" href="../Informes/img/MI180.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../Informes/img/MI32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../Informes/img/MI16.png">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuidv4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        /* Estilos básicos */
        body { font-family: Arial, sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; }
        form {
                min-width: 350px;
                width: 100%;
                
        }
        input[type="text"], input[type="submit"] { width: 100%; padding: 10px; margin: 10px 0; }
        .message { color: red; font-size: 0.9em; }
        .form-group {
            display: flex;
            flex-direction: column;
            margin-left: 15px;
            margin-right: 15px;
            margin-bottom: 15px;
            align-items: flex-start;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            align-content: center;
        }
        .form-container {
            display: flex;
            background-color: white;
            border-radius: 15px;
            border: 1px solid var(--color-blue-100);
            flex-wrap: nowrap;
            flex-direction: column;
            min-width: 350px;
        }
        input[type="text"], input[type="submit"] {
            min-width: 75%;
            padding: 10px;
            margin: 10px 0;
        }
      </style>
</head>
<body>
    <menu id="menucontainer">
        <div id="menutop">
          <div id="menutopleft"><a href="../index.html"> < Atrás</a></div>
          <div id="menutopright">       
            <a href="#">Login</a>      
          </div>
        </div>
        <!-- BARRA DE PROGRESO -->
        <div id="progress-container">
          <div id="progress-bar"></div>
        </div>      
    </menu>

    <form id="LoginForm">
        <div class="form-container"> 
            <div id="headline">          
                <legend><h3>LOGIN</h3></legend>
            </div>
            
            <!-- CAMPOS DEL FORMULARIO -->
            <div class="form-group">
                <label for="username">Usuario:</label>
                <input type="text" id="username" name="username" required><br>
            </div>
            <div class="form-group hidden">
                <label for="uuid">UUID del Dispositivo:</label>
                <input type="text" id="uuid" name="uuid"><br>
            </div>
            
            <div class="form-group">
                <input type="submit" id="submitBtn" value="Enviar">
            </div> 
            
        </div>             
    </form>
    <p id="responseText"></p>
    <footer>
        <div>©2024 EL JARDIN TOL-53140</div>
        <div>       
          <a href="https://github.com/grupos53140/Informes/blob/main/CONDICIONES.md">Condiciones de uso</a> | 
          <a href="https://github.com/grupos53140/Informes/blob/main/PRIVACY.md">Política de privacidad</a>
        </div>
    </footer>

    <!-- Modal para ingresar los tres pares de números -->
    <div id="tokenModal" class="modal" style="display: none; text-align: center;">
        <div class="modal-content">
        <h4>Verificación de acceso</h4>
        <p>Por favor ingresa los tres códigos enviados a tu correo:</p>
        <p>caducaran en 10 mns...:</p>
        <form id="tokenForm">
            <input type="text" id="token1" placeholder="Token 1" required>
            <input type="text" id="token2" placeholder="Token 2" required>
            <input type="text" id="token3" placeholder="Token 3" required>
            <button type="submit">Verificar</button>
        </form>
        </div>
    </div>
    <div id="status-message"></div> <!-- Mensaje de estado -->
    <script>
        // Generar UUID
        //const uuid = uuidv4();
        //document.getElementById('uuid').value = uuid;
    
        const backendUrl = 'https://your-backend-url';

////////////////////////////////////////////////////////////////////////////////
// 1. L O G I N
// 1.1 Maneja el evento de submit en el formulario de login
////////////////////////////////////////////////////////////////////////////////
document.getElementById('loginForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const username = document.getElementById('username').value;
  const loginMessage = document.getElementById('loginMessage');

  try {
    const response = await fetch(backendUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({ action: 'login', username: username, uuid: generateUUID() })
    });

    const result = await response.text();
    loginMessage.textContent = result === 'Accepted' 
      ? 'Login exitoso, revisa tu email para los tokens.' 
      : 'Error: ' + result;

    if (result === 'Accepted') {
      // Si el login es exitoso, mostramos el formulario de verificación
      document.getElementById('loginForm').style.display = 'none';
      document.getElementById('verifyForm').style.display = 'block';
    }
  } catch (error) {
    loginMessage.textContent = 'Error de red. Inténtalo de nuevo.';
    console.error('Error en login:', error);
  }
});

////////////////////////////////////////////////////////////////////////////////
// 1.1.1 Generación de UUID para enviar al backend
////////////////////////////////////////////////////////////////////////////////
function generateUUID() {
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
    const r = Math.random() * 16 | 0;
    const v = c === 'x' ? r : (r & 0x3 | 0x8);
    return v.toString(16);
  });
}

////////////////////////////////////////////////////////////////////////////////
// 2. V E R I F I C A R   T O K E N
// 2.1 Manejo de verificación de tokens enviados por el usuario
////////////////////////////////////////////////////////////////////////////////
document.getElementById('verifyForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const token1 = document.getElementById('token1').value;
  const token2 = document.getElementById('token2').value;
  const token3 = document.getElementById('token3').value;
  const username = document.getElementById('username').value;
  const verifyMessage = document.getElementById('verifyMessage');

  try {
    const response = await fetch(backendUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({
        action: 'verificarToken',
        username: username,
        token1: token1,
        token2: token2,
        token3: token3
      })
    });

    const result = await response.text();
    verifyMessage.textContent = result.includes('https') 
      ? 'Redireccionando...' 
      : 'Error: ' + result;

    if (result.includes('https')) {
      // Redirecciona al usuario con el token en la URL
      window.location.href = result;
    }
  } catch (error) {
    verifyMessage.textContent = 'Error de red. Inténtalo de nuevo.';
    console.error('Error en verificación de tokens:', error);
  }
});
    </script>
    
</body>
</html>

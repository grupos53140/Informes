<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Usuario</title>

    <!-- Librerías necesarias -->
    <link rel="stylesheet" type="text/css" href="../css/paleta.css">
    <link rel="stylesheet" type="text/css" href="../css/index.css">
   
    <link rel="icon" href="../Informes/img/MI.ico" type="image/x-icon">
    <link rel="shortcut icon" href="../Informes/img/MI.ico" type="image/x-icon">
    <link rel="apple-touch-icon" sizes="180x180" href="../Informes/img/MI180.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../Informes/img/MI32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../Informes/img/MI16.png">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuidv4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

</head>
<body>
    <menu id="menucontainer">
        <div id="menutop">
          <div id="menutopleft"><a href="../index.html"> < Atrás</a></div>
          <div id="menutopright">       
            <a href="#">Login</a>      
          </div>
        </div>
        <!-- BARRA DE PROGRESO -->
        <div id="progress-container">
          <div id="progress-bar"></div>
        </div>      
    </menu>

    <form id="LoginForm">
        <div class="form-container"> 
            <div id="headline">          
                <legend><h3>LOGIN</h3></legend>
                <div id="status-message"></div> <!-- Mensaje de estado -->
            </div>
            
            <!-- CAMPOS DEL FORMULARIO -->
            <div class="form-group">
                <label for="username">Usuario:</label>
                <input type="text" id="username" name="username" required><br>
            </div>
            <div class="form-group hidden">
                <label for="uuid">UUID del Dispositivo:</label>
                <input type="text" id="uuid" name="uuid"><br>
            </div>
            <script>
            const multiSelect = CardService.newSelectionInput()
    .setType(CardService.SelectionInputType.MULTI_SELECT)
    .setFieldName("multiselect")
    .setTitle("A multi select input example.")
    .addMultiSelectItem("Contact 1", "contact-1", false,
       "https://www.gstatic.com/images/branding/product/2x/contacts_48dp.png",
       "Contact one description")
    .addMultiSelectItem("Contact 2", "contact-2", false,
       "https://www.gstatic.com/images/branding/product/2x/contacts_48dp.png",
       "Contact two description")
    .addMultiSelectItem("Contact 3", "contact-3", false,
       "https://www.gstatic.com/images/branding/product/2x/contacts_48dp.png",
       "Contact three description")
    .addMultiSelectItem("Contact 4", "contact-4", false,
       "https://www.gstatic.com/images/branding/product/2x/contacts_48dp.png",
       "Contact four description")
    .addMultiSelectItem("Contact 5", "contact-5", false,
       "https://www.gstatic.com/images/branding/product/2x/contacts_48dp.png",
       "Contact five description")
    .setMultiSelectMaxSelectedItems(3)
    .setMultiSelectMinQueryLength(1);
</script>
            <div class="form-group">
               
                <input type="submit" id="submitBtn" value="Enviar">
            </div>         
        </div>             
    </form>

    <footer>
        <div>©2024 EL JARDIN TOL-53140</div>
        <div>       
          <a href="https://github.com/grupos53140/Informes/blob/main/CONDICIONES.md">Condiciones de uso</a> | 
          <a href="https://github.com/grupos53140/Informes/blob/main/PRIVACY.md">Política de privacidad</a>
        </div>
    </footer>

    <script>
        // Generar UUID
            const uuid = uuidv4();
            document.getElementById('uuid').value = uuid;

         // Variables para guardar los valores de grupo y faceta
        let QueryName = {};
        let QueryUser = {};
            //Inicializar la barra de progreso
            finalizarBarraProgreso();
        

            // Escuchar cuando el usuario selecciona un nombre
        document.getElementById('username').addEventListener('input', function() {
            const inputUsername = this.value;

            // Iniciar la barra de progreso
            iniciarBarraProgreso();
            mostrarMensaje("Consultando...");

            // Realizar la consulta para obtener grupo y faceta basados en el nombre
            fetch(`https://script.google.com/macros/s/AKfycbxqs2vqHWcHp3zpT_89IhSoi9OhQVS7Mpy3UGfeZP2C82YxDcL9zYm5q8oNVN_lYsCz/exec?nombre=${inputUsername}`)
            .then(response => response.json())
            .then(data => {
                // Finalizar la barra de progreso
                finalizarBarraProgreso();
                    mostrarMensaje(" ", true);

                // Guardar los valores de nombre y username en las variables
                QueryName = data.nombre;
                QueryUser = data.username; 
                

                // Para mostra en el formulario en etiquetas span:
                document.getElementById('Queryname').textContent = data.nombre;
                document.getElementById('Queryuser').textContent = data.username;

                // Para comprobar que se guardaron correctamente:
                console.log("Quername: ", nombre);
                console.log("Queryuser: ", username);
                // Aquí no se actualiza el HTML, solo se guardan en variables

                finalizarBarraProgreso(); // Asegurarse que la barra llega al 100%
               
            });
        });




        // Enviar datos del formulario
        document.getElementById('LoginForm').addEventListener('submit', function(e) {
            e.preventDefault(); // Prevenir que el formulario se envíe automáticamente

           

            iniciarBarraProgreso();
            mostrarMensaje("Registrando...");

            const username = document.getElementById('username').value;
            const uuid = document.getElementById('uuid').value;
            console.log("Datos: ",username, uuid);
            sendToGoogleSheets(username, uuid);
        });

        function sendToGoogleSheets(username, uuid) {
            const myHeaders = new Headers();
                myHeaders.append('Content-Type', 'application/json');

                const raw = JSON.stringify({
                "action": 'auth',
                "username": username,
                "uuid": uuid
                });

                const requestOptions = {
                method:     'POST',
                headers:    myHeaders,
                mode:       'cors',
                body:       raw,
                redirect:   'follow'
                };
                console.log("RAW: ", raw);
                fetch("https://script.google.com/macros/s/AKfycbxD9pH7VFa7IseLpqcPxNCDEQ28MvimPY_nxaox_X_KbBKgJkTegJ7TL652iA6ejQ/exec", requestOptions)
                .then((response) => response.text("Estoes Response: ", response))
                .then((result) => console.log("Esto es result:",result))
                .catch((error) => console.error("Esto es Error: ",error));
        }

        function iniciarBarraProgreso() {
            const progressBar = document.getElementById('progress-bar');
            let progreso = 0;
            const intervalo = 100; 
            const idIntervalo = setInterval(() => {
                progreso += 5;
                progressBar.style.width = `${progreso}%`;
                if (progreso >= 100) {
                    clearInterval(idIntervalo);
                }
            }, intervalo);
        }

        function finalizarBarraProgreso() {
            const progressBar = document.getElementById('progress-bar');
            progressBar.style.transition = 'width 0.5s ease';
            progressBar.style.width = '0%'; // Finaliza la barra al 100%
        }

        function mostrarMensaje(mensaje, isSuccess = false) {
            const statusMessage = document.getElementById('status-message');
            if (isSuccess) {
                statusMessage.innerHTML = `<span style="color: var(--color-blue-100);">${mensaje} <i class="fas fa-check-circle"></i></span>`;
            } else {
                statusMessage.innerHTML = `<span style="color: red;">${mensaje} <i class="fas fa-exclamation-circle"></i></span>`;
            }
        }

        // TEST DE PRUEBAS
        
        /*
             logData(); // Verificar datos antes de enviarlos

             <input type="button" id="logDataBtn" value="Verificar en Consola">

              // Función para mostrar los datos por consola
        function logData() {
            const username = document.getElementById('username').value;
            const nombre = document.getElementById('nombre').value;
            const uuid = document.getElementById('uuid').value;

            // Mostrar los datos en la consola del navegador
            console.log('Datos ingresados por el usuario:');
            console.log('Usuario:', username);
            console.log('Nombre:', nombre);
            console.log('UUID:', uuid);

            // Validación simple
            if (!username || !nombre || !uuid) {
                console.error('Faltan campos obligatorios.');
                alert('Por favor, completa todos los campos.');
                return;
            }

            console.log('Todos los campos están completos.');
        }

        // Evento para verificar los datos en la consola
        document.getElementById('logDataBtn').addEventListener('click', function() {
            logData();
        });
            */
        


    </script>
</body>
</html>
